#Область Пользователи
//Создание временной таблицы пользователй
&НаСервере
Функция ПолучитьПолучателей(Документ) Экспорт  		
	Результат = Новый ТаблицаЗначений;
	Результат.Колонки.Добавить("Пользователь");
	Результат.Колонки.Добавить("Должность"); 
	
	Для Каждого Строка из Документ.ПР_Получатель Цикл 
		НовСтр = Результат.Добавить();    
		НовСтр.Пользователь = Строка.Получатель;
		НовСтр.Должность = "";
	КонецЦикла;
	Возврат Результат; 
КонецФункции

//Нахождение руководителя автора и дополнение таблицы
&НаСервере
Функция НайтиРуководителяАвтора(Получатели, Документ) Экспорт
	
	Автор = Документ.Подготовил; 
	
	Пользователь = Справочники.Пользователи.НайтиПоНаименованию(Автор);
	ПодразделениеАвтора = Пользователь.Подразделение; 
	Подразделение = Справочники.СтруктураПредприятия.НайтиПоНаименованию(ПодразделениеАвтора);
	Руководитель = Подразделение.Руководитель; 
	
	Если  Руководитель = Автор Тогда
		Руководитель = Автор; 
	КонецЕсли; 
	 
	Если НЕ ЗначениеЗаполнено(Получатели.Найти(Руководитель, "Пользователь")) Тогда
		НовСтр = Получатели.Добавить();
		НовСтр.Пользователь = Руководитель;
		НовСтр.Должность = "РуководительАвтора";
	КонецЕсли;
			
	Возврат Руководитель; 
КонецФункции

//Нахождение руководителя исполнителя и дополнение таблицы
&НаСервере
Функция НайтиРуководителяАдресата(Получатели, Документ) Экспорт
 		Адресат = Документ.Адресат;
	
	Если НЕ ЗначениеЗаполнено(Получатели.Найти(Адресат, "Пользователь")) Тогда 
		НовСтр = Получатели.Добавить();
		НовСтр.Пользователь = Адресат;
		НовСтр.Должность = ""; 
	КонецЕсли;	
	
		Пользователь = Справочники.Пользователи.НайтиПоНаименованию(Адресат);
		ПодразделениеАдресата = Пользователь.Подразделение; 
		Подразделение = Справочники.СтруктураПредприятия.НайтиПоНаименованию(ПодразделениеАдресата);
		Руководитель = Подразделение.Руководитель;

 	
	Если НЕ ЗначениеЗаполнено(Получатели.Найти(Руководитель, "Пользователь")) Тогда	
		НовСтр = Получатели.Добавить();
		НовСтр.Пользователь = Руководитель;
		НовСтр.Должность = "РуководительИсполн";
	КонецЕсли;	
    Возврат Руководитель;	
КонецФункции
#КонецОбласти   

#Область Шаблоны
//строка исполнителя
Процедура СозданиеШаблонаИсполненияИЗаполнениеСтроки (Автор, Получатели, РуководителяАвтора, РуководительАдресета, Объект)Экспорт
	//Что бы любой пользователь мог воспользоваться дороботкой	
	УстановитьПривилегированныйРежим(Истина);  
	Попытка
	//Создние шаблона
	ПустойШаблонИсполнения = Справочники.ШаблоныИсполнения.НайтиПоНаименованию("По умолчанию");
	ШаблонИсполненияНовый = Справочники.ШаблоныИсполнения.СоздатьЭлемент();
	ШаблонИсполненияНовый.Автор = Автор;
	ШаблонИсполненияНовый.Важность = Перечисления.ВариантыВажностиЗадачи.Обычная;
	ШаблонИсполненияНовый.ВариантУстановкиСрокаОбработкиРезультатов = Перечисления.ВариантыУстановкиСрокаИсполнения. ОтносительныйСрок;
	ШаблонИсполненияНовый.ВладелецШаблона = Объект.Ссылка; 
	Для каждого Строка из Получатели Цикл
		Если Строка.Должность = "" 
			И НЕ (РуководителяАвтора = Строка.Пользователь
			Или РуководительАдресета = Строка.Пользователь) Тогда
			НовыйИсполнитель = ШаблонИсполненияНовый.Исполнители.Добавить();
			НовыйИсполнитель.Исполнитель = Строка.Пользователь;
		КонецЕсли;
	КонецЦикла;
	ШаблонИсполненияНовый.ИсходныйШаблон = ПустойШаблонИсполнения; 
	ШаблонИсполненияНовый.КомплексныйПроцесс = Объект.Ссылка;
	ШаблонИсполненияНовый.КоличествоИтераций = 1;
	ШаблонИсполненияНовый.НаименованиеБизнесПроцесса = "служебной записки";
	ШаблонИсполненияНовый.Записать();
	ШаблонСсылка = ШаблонИсполненияНовый.Ссылка;
	
	//Заполенеи таблицы Этапы
	ИмяТипа = "";
	НоваяСтрока = Объект.Этапы.Добавить(); 
	НоваяСтрока.ШаблонБизнесПроцесса = ШаблонСсылка; 
	РабочийШаблон = НоваяСтрока.ШаблонБизнесПроцесса;
	
	МенеджерШаблона = ОбщегоНазначения.МенеджерОбъектаПоСсылке(РабочийШаблон);
	РеквизитыШаблона = МенеджерШаблона.РеквизитыЭтапаДляВычисляемыхПолей(РабочийШаблон);
	
	ИмяПроцесса = МенеджерШаблона.ИмяПроцесса(РабочийШаблон);
	ИмяТипа = МенеджерШаблона.СинонимПроцесса(ИмяПроцесса, РеквизитыШаблона) + ": ";
	
	НоваяСтрока.ЗадачаЭтапа = ИмяТипа + РеквизитыШаблона.НаименованиеБизнесПроцесса;
	НоваяСтрока.ИсполнителиЭтапаСтрокой = МенеджерШаблона.ПолучитьСтроковоеПредставлениеИсполнителей(РеквизитыШаблона);
	НоваяСтрока.ИсполнителиПредставление = 
	НоваяСтрока.ИсполнителиПредставление + Строка(МенеджерШаблона.ПолучитьСтроковоеПредставлениеИсполнителей(РеквизитыШаблона));
Исключение
	Сообщить ("Ошибка при создании шаблона: " + ОписаниеОшибки(), СтатусСообщения.Важное); 
КонецПопытки;

	УстановитьПривилегированныйРежим(Ложь);
	КонецПроцедуры   

// строка согласования
Процедура СозданиеШаблонаСогласованияИЗаполнениеСтроки (Автор, РуководителяАвтора, Объект) Экспорт
	//Что бы любой пользователь мог воспользоваться дороботкой	
	УстановитьПривилегированныйРежим(Истина);
	Попытка
	//Создние шаблона
	ПустойШаблонСогласования = Справочники.ШаблоныСогласования.НайтиПоНаименованию("По умолчанию");
	ШаблонСогласованияНовый = Справочники.ШаблоныСогласования.СоздатьЭлемент();
	ШаблонСогласованияНовый.Автор = Автор;
	ШаблонСогласованияНовый.Важность = Перечисления.ВариантыВажностиЗадачи.Обычная;
	ШаблонСогласованияНовый.ВариантУстановкиСрокаОбработкиРезультатов = Перечисления.ВариантыУстановкиСрокаИсполнения. ОтносительныйСрок;
	ШаблонСогласованияНовый.ВладелецШаблона = Объект.Ссылка;
	НовыйИсполнитель = ШаблонСогласованияНовый.Исполнители.Добавить();
	НовыйИсполнитель.Исполнитель = РуководителяАвтора;
	ШаблонСогласованияНовый.ИсходныйШаблон = ПустойШаблонСогласования; 
	ШаблонСогласованияНовый.КомплексныйПроцесс = Объект.Ссылка;  
	ШаблонСогласованияНовый.КоличествоИтераций = 1; 
	ШаблонСогласованияНовый.ВариантСогласования =  Перечисления.ВариантыМаршрутизацииЗадач.Последовательно;
	ШаблонСогласованияНовый.НаименованиеБизнесПроцесса = "служебной записки из своего подраздедления";
	ШаблонСогласованияНовый.Записать();
	ШаблонСсылка = ШаблонСогласованияНовый.Ссылка;
	
	//Заполенеи таблицы Этапы
	ИмяТипа = "";
	НоваяСтрока = Объект.Этапы.Добавить(); 
	НоваяСтрока.ШаблонБизнесПроцесса = ШаблонСсылка; 
	РабочийШаблон = НоваяСтрока.ШаблонБизнесПроцесса;
	
	МенеджерШаблона = ОбщегоНазначения.МенеджерОбъектаПоСсылке(РабочийШаблон);
	РеквизитыШаблона = МенеджерШаблона.РеквизитыЭтапаДляВычисляемыхПолей(РабочийШаблон);
	
	ИмяПроцесса = МенеджерШаблона.ИмяПроцесса(РабочийШаблон);
	ИмяТипа = МенеджерШаблона.СинонимПроцесса(ИмяПроцесса, РеквизитыШаблона) + ": ";
		
	НоваяСтрока.ЗадачаЭтапа = ИмяТипа + РеквизитыШаблона.НаименованиеБизнесПроцесса;
	НоваяСтрока.ИсполнителиЭтапаСтрокой = МенеджерШаблона.ПолучитьСтроковоеПредставлениеИсполнителей(РеквизитыШаблона);
	НоваяСтрока.ИсполнителиПредставление = НоваяСтрока.ИсполнителиЭтапаСтрокой;    
 Исключение 
	 Сообщить("Ошибка при создании шаблона: " + ОписаниеОшибки(), СтатусСообщения.Важное);
 КонецПопытки;
 
	УстановитьПривилегированныйРежим(Ложь);
КонецПроцедуры

//срока рассмотрения
Процедура СозданиеШаблонаРассмотрениеИЗаполнениеСтроки (Автор, РуководительАдресета, Объект) Экспорт
	
	УстановитьПривилегированныйРежим(Истина); 
	Попытка
	
	ПустойШаблонРассмотрения = Справочники.ШаблоныРассмотрения.НайтиПоНаименованию("По умолчанию");
	ШаблонРасссмотренияНовый = Справочники.ШаблоныРассмотрения.СоздатьЭлемент();
	ШаблонРасссмотренияНовый.Автор = Автор;
	ШаблонРасссмотренияНовый.Важность = Перечисления.ВариантыВажностиЗадачи.Обычная;
	ШаблонРасссмотренияНовый.ВариантУстановкиСрокаОбработкиРезультатов = Перечисления.ВариантыУстановкиСрокаИсполнения. ОтносительныйСрок;
	ШаблонРасссмотренияНовый.ВладелецШаблона = Объект.Ссылка;
	ШаблонРасссмотренияНовый.Исполнитель = РуководительАдресета;
	ШаблонРасссмотренияНовый.ИсходныйШаблон = ПустойШаблонРассмотрения; 
	ШаблонРасссмотренияНовый.КомплексныйПроцесс = Объект.Ссылка;
	ШаблонРасссмотренияНовый.НаименованиеБизнесПроцесса = "служебной записки из другого подраздедления";
	ШаблонРасссмотренияНовый.Записать();
	ШаблонСсылка = ШаблонРасссмотренияНовый.Ссылка;
	
	//дальше сам не совсем понимаю как, но вставляет текст мз шаблона в строку этапа. 
	ИмяТипа = "";
	НоваяСтрока = Объект.Этапы.Добавить(); 
	НоваяСтрока.ШаблонБизнесПроцесса = ШаблонСсылка; 
	РабочийШаблон = НоваяСтрока.ШаблонБизнесПроцесса;
	
	МенеджерШаблона = ОбщегоНазначения.МенеджерОбъектаПоСсылке(РабочийШаблон);
	РеквизитыШаблона = МенеджерШаблона.РеквизитыЭтапаДляВычисляемыхПолей(РабочийШаблон);
	
	ИмяПроцесса = МенеджерШаблона.ИмяПроцесса(РабочийШаблон);
	ИмяТипа = МенеджерШаблона.СинонимПроцесса(ИмяПроцесса, РеквизитыШаблона) + ": ";  
	
	НоваяСтрока.ЗадачаЭтапа = ИмяТипа + РеквизитыШаблона.НаименованиеБизнесПроцесса;
	НоваяСтрока.ИсполнителиЭтапаСтрокой = МенеджерШаблона.ПолучитьСтроковоеПредставлениеИсполнителей(РеквизитыШаблона);
	НоваяСтрока.ИсполнителиПредставление = НоваяСтрока.ИсполнителиЭтапаСтрокой;
Исключение 
	 Сообщить("Ошибка при создании шаблона: " + ОписаниеОшибки(), СтатусСообщения.Важное);
КонецПопытки;
	УстановитьПривилегированныйРежим(Ложь);
	КонецПроцедуры
#КонецОбласти    
